pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--setup
gravity=0.4
friction=0.65
fps_dt=0.333
	
function _init()
	restart()
	_draw_world=draw_world
end

function restart()
	p={}
	p.x=59
	p.y=59
	p.w=8
	p.h=8
	p.dx=0
	p.dy=0
	p.max_dx=1.5
	p.max_dy=4
	p.acc_x=0.65
	p.acc_y=3
	p.flipx=false
	p.on_floor=false
	set_anim(p,"idle")
	
	treat={}
	treat.x=16
	treat.y=112
	treat.spr=48
	treat.anim={
		f0=48,
		f1=51,
		dt=0.125,
		t=time()
	}
end

function set_anim(p,name)
	local a={ name=name, t=time() }
	if name=="idle" then
		a.f0=0
		a.f1=1
		a.dt=0.5
	elseif name=="run" then
		a.f0=3
		a.f1=6
		a.dt=0.125
	end
	p.anim=a
	p.spr=a.f0
end


-->8
--update
function _update()
	local p=p
	
	--general
	p.dy+=gravity
	p.dx*=friction
	
	--controls
	if p.on_floor and btnp(❎) then
		p.on_floor=false
		p.dy=-p.acc_y
	end
	
	if btn(⬅️) then p.dx-=p.acc_x end
	if btn(➡️) then p.dx+=p.acc_x end
	
	--limits
	if abs(p.dx)<0.1 then p.dx=0 end
	p.dx=mid(-p.max_dx,p.dx,p.max_dx)
	p.dy=mid(-p.max_dy,p.dy,p.max_dy)

	--position
	local old_x,old_y=p.x,p.y
	p.x+=p.dx
	p.y+=p.dy
	
	--collision
	collide_player(p,old_x,old_y)
	
	--animation
	local anim=p.anim.name
	if p.on_floor then
		if p.dx!=0 and anim!="run" then
			set_anim(p, "run")
		elseif p.dx==0 and anim!="idle" then
			set_anim(p, "idle")
		end
	else
		p.anim={ name="none" }
		if p.dy>0 then
			p.spr=10	
		else
			p.spr=8
		end
	end
	
	update_anim(p)
	update_anim(treat)
	
	--direction
	if p.dx<0 then
		p.flipx=true
	elseif p.dx>0 then
		p.flipx=false
	end
end

function update_anim(p)
	local a=p.anim
	if a.name=="none" then return end
	if time()-a.t>a.dt then
		a.t=time()
		p.spr+=1
		if p.spr>a.f1 then
			p.spr=a.f0 --wrap around
		end
	end
end
-->8
--draw
function _draw()
	cls(12)
	
	camera(max(64,p.x)-64,0)
	_draw_world()
	draw_treat()
	
	camera()
	draw_ui()
end

function draw_world()
	map(0,0)
	spr(p.spr,p.x,p.y,1,1,p.flipx)
end

function draw_world_debug()
	map(0,0)
	rectfill(8*tx0,8*ty0,8*tx1+7,8*ty1+7,10)
	for e in all(collisions) do
		rectfill(8*e.x+1,8*e.y+1,8*e.x+6,8*e.y+6,8)
	end
 spr(p.spr,p.x,p.y,1,1,p.flipx)
	rect(aabb.x0,aabb.y0,aabb.x1,aabb.y1,2)
end

function draw_treat()
	pal(5,9)
	pal(6,10)
	spr(treat.spr,treat.x,treat.y)
	pal()
end

function draw_ui()
	print("dx "..p.dx,1,1,7)
	print("dy "..p.dy,1,9,7)
end

-->8
--math
function sign(n)
	return n>0 and 1 or n<0 and -1 or 0
end

function vec_dot(v1x,v1y,v2x,v2y)
	return v1x*v2x+v1y*v2y
end
-->8
--collision
aabb={}
tx0=0
ty0=0
tx1=0
ty1=0
collisions={}

function collide_player(p,old_x,old_y)
	collisions={}
	
	--aabb of old and new pos
	local x0=min(p.x,old_x)
	local x1=max(p.x,old_x)+p.w-1
	local y0=min(p.y,old_y)
	local y1=max(p.y,old_y)+p.h-1	 
	aabb.x0=x0  aabb.x1=x1
	aabb.y0=y0  aabb.y1=y1
	
	--tiles in aabb
	tx0=flr(x0/8)
	tx1=flr(x1/8)
	ty0=flr(y0/8)
	ty1=flr(y1/8)
	
	for ty=ty0,ty1 do
		for tx=tx0,tx1 do	
		 if fget(mget(tx,ty),0) then
		 	resolve(p,contact(p,tx,ty),tx,ty)
		 end
		end
	end
end

function contact(p,tx,ty)
	--player, tile x and y
	
	--player center
	local pcx=p.x+p.w/2-0.5
	local pcy=p.y+p.h/2-0.5
	
	--tile aabb
	local tcx=8*tx+3.5
	local tcy=8*ty+3.5
	local tbb_w=8+p.w --inflate
	local tbb_h=8+p.h
	
	--tile -> player vector
	local vx=pcx-tcx
	local vy=pcy-tcy
	
	local nx,ny,d
	if abs(vx)>abs(vy) then
		nx=sign(vx)
		ny=0
		d=abs(vx)-tbb_w/2
	else
		nx=0
		ny=sign(vy)
		d=abs(vy)-tbb_h/2
	end
	
	return {nx=nx,ny=ny,dist=d}
end

function resolve(p,c,tx,ty)
	--player, contact, tile x and y
	
	--prevent inner-edge collisions
	if (fget(mget(tx+c.nx,ty+c.ny),0)) return
	
	--player normal velocity
	local vn=vec_dot(p.dx,p.dy,c.nx,c.ny)
	
	--penetration/separation
	local nv=vn+max(0,c.dist)*fps_dt
	
	--if is penetrating
	if nv<0 then
		add(collisions, {x=tx,y=ty})
		if c.nx!=0 then
			p.dx=0
			p.x-=c.nx*nv
		elseif p.dy>0 then
			p.dy=0
			p.y-=p.y%8
			p.on_floor=true
		end
	end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00090110000901100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00041400000414000009011000090011000090110009011000090110000000000000001100090011000901100000000000000000000000000000000000000000
00004990000049900004140000004140000041400004140004041400000901100009414000004140040414000009011000000000000000000000000000000000
00001100000011000400499000000499044004994400499004004990040414000000049900000499041049900404140000000000000000000000000000000000
0001a4000001a400041a10000441a1000001a100094a1000001a1000040049900041a1000441a100094a1000041a499000000000000000000000000000000000
00011400040114000041100000041190009411000011100000411000001a10000404119000941190000110000041100000000000000000000000000000000000
04449990004499900090900000900000000009000009000000990000009119000009000000000000000090000009900000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666d60dddddd000bbbbbbbbbbbbbbbbbbbbb00004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
dbdddd1dd55555550bbbbbbbbbbbbbbbbbbbbbbb0004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
b3bbbbbb011113300bbbbbbbbbbbbbbbbbbbbbbb0054400000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbb3055555b00bbbbbbbbbbbbbbbbbbbbbbb0004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb05d5d5d003bbbbbb3bbbbbbb3bbbbbb30004440000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb3b3bbb05d5d5d0033bbbb333bbbbb333bbbb330004500000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbb4bbbb05d5d5d00033333333333333333333300004500000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb012121200003333333333333333333000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05500550005566000006600000655500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550005556000006600000665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555500000560000006600000055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550005556000006600000665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05500550005566000006600000655500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000010102020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000002223240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2100000025000022232400000000000000000000000000000021210000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2100002223240000250000000000000021212100000021000000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2100000025000022232323240000002121000000002121210000000000000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
